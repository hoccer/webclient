<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Hoccer Wall</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Robert Palmer">
	<!-- Date: 2010-12-15 -->
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	
	<script src="lib/linccer/lib/jquery-1.4.4.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer/lib/base.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer/lib/linccer.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer/lib/filecache.js" type="text/javascript" charset="utf-8"></script>
	<script src="hoccer_map.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">	
		$(document).ready(function() {
			var MAX_SIZE = $(document).height() - 200,
			    MAX_ROTATION = 15
					MAX_ELEMENTS = 6;
			
			var LOCATION_ERROR = 'Could not locate you. Please set your location manually.';
			var TIMEOUT_ERROR = 'No transfer partner found';
			
			var linccer = Linccer( {'api_key' : 'b3b03410159c012e7b5a00163e001ab0' , server: 'beta' });
			var map = HoccerMap("map_canvas", "address_field");
			map.show();
			var images = [];
			
			var scaleImage = function(img) {
				if (img.width > img.height) {
					if (img.width > MAX_SIZE) {
						img.width = MAX_SIZE;
					}
				} else {
					if (img.height > MAX_SIZE) {
						img.height = MAX_SIZE;
					}	
				}
			}
			
			var positionElement = function(element) {
				var doc = $(window);
				
				console.log(doc.height(), doc.width());
				var top = doc.height() / 2 - element.height() / 2;
				var left = doc.width() / 2 - element.width() / 2;
				
				element.css({ 'top': top + 'px', 'left': left+'px' });
			}
			
			var addImage = function(uri) {
				var img = new Image(),
						rotation = Math.floor(Math.random() * 16) * ((Math.floor(Math.random() * 2) - 1) | 1);
						
				img.src = uri;
				img.onload = function() {
					scaleImage(img);
					var div = $("<div></div").
									append(img).
									attr('class', 'image').
									css({ '-webkit-transform': 'rotate(' + rotation + 'deg)' }).
									css({ '-moz-transform': 'rotate(' + rotation + 'deg)' }).
									appendTo('body');

					positionElement(div);
					
					images.push(div);
					if (images.length > MAX_ELEMENTS) {
						$(images.shift()).remove();
					}
				}
			}
			
			var watch = function() {
				linccer.receive( 'one-to-many', { 'waiting': 'true', 'timeout': 20000 } );
			}
			
			linccer.on('ready', function() {
				console.log('ready');
				watch();
			})
			
			linccer.on('updated_environment', function(data) {
				console.log('updated environment');
			});
			
			linccer.on('received', function(data) {
				console.log(data);
				
				var firstContent = data[0]['data'][0];
				
				if (firstContent.type.match(/^image\/*/)) {
					addImage(firstContent.uri);
				}
				
				watch();
			});
		
			linccer.on('error', function(error) {
				console.log(error);
				
				if (error.code == 3) {
					console.log('position error');
				} else if (error.message === 'request_timeout') {
					watch();
				} else {
					console.log(error);
				}
			});
			
			linccer.on('updated_environment', function(data) {
				map.setCenter(data.gps.latitude, data.gps.longitude)
			});
			
			map.on('position_changed', function() {
				console.log('position changed');
				linccer.setEnvironmentCoordinates(map.latitude, map.longitude, 300);
			});
			
			$("#info_button").click(function() {
 	 	 		$("#settings").show();
				google.maps.event.trigger(map, 'resize');
				map.show();
				
				return false;
			});
			
			$("#done").click(function() {
				$("#settings").hide();
				return false;
			});
		});

	</script>
	
	<style type="text/css" media="screen">
		html, body {
			padding 0; margin: 0;
			height: 100%;
		}

		#wall { 
			background: black url('images/bg_main.jpg') repeat-x;
			height: 100%;
			width: 100%;
		}
		
		#info_button {
			position: absolute;
			bottom: 10px;
			right: 10px;
		}
		
		.image { 
			position: absolute;
			margin: auto;
			background-color: white; 
			
			padding: 10px;
		}
		
		#settings {
			position: absolute;
			top: 0; right: 0;
			
			width: 506px;
			height: 100%;
			z-index	: 1;
			
			padding: 0 20px;
			
			background: url('images/bg_settings.jpg');
			color: white;
			font: 75% "Trebuchet MS", Verdana, sans-serif;
			
			display: none;
		}
		
		#done {
			bottom: 20px;
			right: 20px;
			position: absolute;
		}
		
		#map_canvas {
			margin: 0 auto;
			width : 486px;
			height: 350px;
		}
		
	</style>
	<body>
		<div id="wall">
			<img src="images/logo.png" width="256" height="64" alt="Logo">
			<a id="info_button" href="#"><img src="images/i.png" width="46" height="46" alt="info"></a>
		</div>
		
		<div id="settings">
			<h1>Settings</h1>
			
			<div id="map_canvas"></div>
			
			<input id="address_field" type="text" value="" />
			
			<a id="done" href="#"><img src="images/done.png" width="130" height="52" alt="Done"></a>
		</div>
		
	</body>

</html>
