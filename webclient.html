<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Hoccer Webclient</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Robert Palmer">
	<!-- Date: 2010-12-15 -->
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	
	<script src="lib/linccer/lib/jquery-1.4.4.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer/lib/base.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer/lib/linccer.js" type="text/javascript" charset="utf-8"></script>
	<script src="lib/linccer/lib/filecache.js" type="text/javascript" charset="utf-8"></script>
	
	<script type="text/javascript" charset="utf-8">
		var HoccerMap = function(id) {
			var that = {};
			HC.observable(that);
			var geocoder = new google.maps.Geocoder();
			
			var latlng = new google.maps.LatLng(52, 13);
			var myOptions = {
		    zoom: 16,
		    center: latlng,
		    mapTypeId: google.maps.MapTypeId.ROADMAP
		  };
		  var map = new google.maps.Map(document.getElementById(id), myOptions);
			
			var marker = new google.maps.Marker({
	      map: map,
	      draggable: true,
	      animation: google.maps.Animation.DROP
	    });
			
			var geocode = function() {
				geocoder.geocode({"latLng": new google.maps.LatLng(that.latitude, that.longitude) }, function(result, status) {
					if (status != google.maps.GeocoderStatus.OK) {
						return;
					}
					
					that.fire('address_changed', result[0].formatted_address);
				});
			}
			
			google.maps.event.addListener(marker, 'dragend', function() {
				
				that.latitude = marker.getPosition().lat();
				that.longitude = marker.getPosition().lng();
				that.fire('position_changed');
				
				geocode();	
			});
			
			that.setCenter = function(latitude, longitude) {
				that.latitude = latitude;
				that.longitude = longitude;
				
				var pos = new google.maps.LatLng(that.latitude, that.longitude);
				map.panTo(pos);
				
				marker.setPosition(pos);
				geocode();
			}
			
			that.resize = function() {
				google.maps.event.trigger(map, 'resize');
			}
			
			that.setAddress = function(address) {
				geocoder.geocode({"address": address}, function(result, status) {
					if (status != google.maps.GeocoderStatus.OK) {
						return;
					}

					that.setCenter(result[0].geometry.location.lat(), result[0].geometry.location.lng());
				});
			}

			return that;
		}
		
		var WebClient = function(map) {
			var that = {};
			HC.observable(that);
						
			$("#sendButton").click(function() { that.fire('send'); } );
			$("#receiveButton").click(function() {that.fire('receive') } );
			$("#show_map > a").click(function() { $("#map_container").slideDown(), map.resize()} );
			$("#addressForm").submit( function(event) {
					map.setAddress($("#addressInput").val());
					event.stopPropagation();
					return false;
			});
						
			that.enableSend = function() {
			};
			
			that.enableReceive = function() {
			};
			
			that.displayLocation = function(location) {
				$("#waiting").css("display", "none");
				$("#coordinates").css("display", "inline");
			};
			
			that.showUploadingState = function() {
				// $("#").css("display": "none");	
			};
			
			that.uploadReady = function() {
				
			}
			
			return that;
		}
	
		$(document).ready(function() {
			var fileCache = FileCache( {'api_key': 'e101e890ea97012d6b6f00163e001ab0', 'server': 'beta' });			
			var linccer = Linccer( {'api_key' : 'e101e890ea97012d6b6f00163e001ab0', 'server': 'beta'});

			var map = HoccerMap('map_canvas');
			var client = WebClient(map);
		 	
		  map.on('position_changed', function() {
				linccer.setEnvironmentCoordinates(map.latitude, map.longitude, 100);
			});
			
			map.on('address_changed', function(address) {
				$("#coordinates").text(address);
			})
		
		  client.on('send', function() {
				var content = document.getElementById("fileInputField").value;
				var data = [
				   {
						"type": "text/plain",
						"content": content
						}
				];

				linccer.send("one-to-many", data);
			});

			client.on('receive', function() {
				linccer.receive("one-to-many")
			});
			
			fileCache.on('started', function(url) {
				console.log('started:' + url);
			});
			
			fileCache.on('progress', function(progress) {
				// console.log(progress);
			});

			fileCache.on('uploaded', function(uri) {
		    console.log("uploaded: " + uri);
			});
			
			linccer.on('sent', function(data) {
				console.log("sent!!!!!! " + data);
			});
			
			linccer.on('ready', function() {
				client.displayLocation();
			})
			
			linccer.on('updated_environment', function(data) {
				console.log('updated environments!!!!!');
				map.setCenter(data.gps.latitude, data.gps.longitude)
			});
			
			linccer.on('received', function(data) {
				console.log(data);
				document.getElementById("input").value = data[0][0].content;
			});
			
			linccer.on('error', function(error) {
				console.log(error);
			});
						
			$("#fileInputField").change(function() {
				var file = document.getElementById('fileInputField').files[0];
				fileCache.upload(file);
			});				
		});
		

		
	</script>
	
	<style type="text/css" media="screen">
	
		#content { width: 700px; margin: 0 auto}
		#content > div { padding-top: 20px;}
		#location #coordinates { display: none; }
		
		#map_canvas { height: 450px; }
		#map_container { display: none; }
	</style>
	
</head>
<body>

	<div id="content">
		<div id="location">
			<span id="waiting">locating...</span>
			<span id="coordinates">32,12 1212</span>
			
			<span id="show_map"><a href="#">showMap</a></span>
			<div id="map_container">
				<form id="addressForm"><input id="addressInput" type="text" /><input type="Submit" value="search" /></form>
				<div id="map_canvas">
				</div>
			</div>
		</div>

		<div>			
			File: <input id="fileInputField" type="file" name="upload[filename]" />
		</div>
		<div>
			<a href="#" id="receiveButton">Receive</a>
			<a href="#" id="sendButton">Send</a>
		</div>



</div>
</body>
</html>
