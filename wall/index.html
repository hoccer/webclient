<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Hoccer Wall</title>
  <meta name="generator" content="TextMate http://macromates.com/">
  <meta name="author" content="Robert Palmer">
  <!-- Date: 2010-12-15 -->
  <script src="http://hoccer.com/webapp/lib/linccer/lib/jquery-1.4.4.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://hoccer.com/webapp/lib/linccer/lib/json_parse.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://hoccer.com/webapp/lib/linccer/lib/base.js" type="text/javascript" charset="utf-8"></script>
  <!-- // <script src="http://hoccer.com/webapp/lib/linccer/lib/linccer.js" type="text/javascript" charset="utf-8"></script> -->
  <script src="../lib/linccer/lib/linccer.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://hoccer.com/webapp/lib/linccer/lib/filecache.js" type="text/javascript" charset="utf-8"></script>
  <script src="http://hoccer.com/webapp/hoccer_map.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" src="http://jquery-jsonp.googlecode.com/files/jquery.jsonp-1.0.4.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
      var MAX_SIZE = $(document).height() - 200,
          MAX_ROTATION = 15,
          MAX_ELEMENTS = 6;

      var LOCATION_ERROR = 'Could not locate you. Please set your location manually.',
          TIMEOUT_ERROR = 'No transfer partner found';

      var linccer = Linccer( {"api_key" : "b3b03410159c012e7b5a00163e001ab0" });
      var images = [],
          iframeDiv,
          map = HoccerMap("map_canvas", "address_field");

      map.show();
      linccer.setEnvironmentCoordinates(52.51666009426117, 13.40919971466064, 20000);

      var scaleImage = function(img) {
        if (img.width > img.height) {
          if (img.width > MAX_SIZE) {
            img.width = MAX_SIZE;
          }
        } else {
          if (img.height > MAX_SIZE) {
            img.height = MAX_SIZE;
          }
        }
      };

      var positionElement = function(element) {
        var doc = $(window);

        var top = doc.height() / 2 - element.height() / 2;
        var left = doc.width() / 2 - element.width() / 2;

        element.css({ 'top': top + 'px', 'left': left+'px' });
      };

      var addImage = function(uri) {
        var img = new Image(),
            rotation = Math.floor(Math.random() * 16) * ((Math.floor(Math.random() * 2) - 1) | 1);

        img.src = uri;
        img.onload = function() {
          if (iframeDiv !== undefined) {
            $(iframeDiv).remove();
            iframeDiv = undefined;
          }

          scaleImage(img);
          var div = $("<div></div").
                  append(img).
                  attr('class', 'image').
                  css({ '-webkit-transform': 'rotate(' + rotation + 'deg)' }).
                  css({ '-moz-transform': 'rotate(' + rotation + 'deg)' }).
                  appendTo('#wall');

          positionElement(div);

          images.push(div);
          if (images.length > MAX_ELEMENTS) {
            $(images.shift()).remove();
          }
        }
      };

      var addYoutube = function(uri) {
        var iframe = $('<iframe title="YouTube video player" width="853" height="510" src="'
                          + uri + '?rel=0&autoplay=1" frameborder="0"></iframe>');

        iframeDiv = $("<div></div").
            append(iframe).
            attr('class', 'image').
            appendTo('#wall');

        positionElement(iframeDiv);
      };

      var watch = function() {
        linccer.receive( 'one-to-many', { 'waiting': 'true', 'timeout': 15000 } );
      };

      linccer.on('ready', function() {
        watch();
      });

      linccer.on('received', function(data) {
        // console.log(data);

        var firstContent = data[0]['data'][0];

        if (firstContent.type.match(/^image\/*/)) {
          addImage(firstContent.uri);
        } else if (firstContent.type === 'text/uri-list' && firstContent.content.match(/www\.youtube\.com/)) {

        var uri = firstContent.content.replace("watch?v=", "embed/");
          addYoutube(uri);
        };

        watch();
      });

      linccer.on('error', function(error) {
        if (error.code == 3 || error.code == 1) {
          $("#settings").show();
          map.show();
        } else if (error.message === 'request_timeout') {
          setTimeout( function() { watch(); }, 100);
        }
      });

      linccer.on('updated_environment', function(data) {
        map.setCenter(data.gps.latitude, data.gps.longitude)
      });

      map.on('position_changed', function() {
        linccer.setEnvironmentCoordinates(map.latitude, map.longitude, 300);
      });

      $("#info_button").click(function() {
        $("#settings").show();
        google.maps.event.trigger(map, 'resize');
        map.show();

        return false;
      });

      $("#done").click(function() {
        $("#settings").hide();
        return false;
      });
    });

  </script>

  <style type="text/css" media="screen">
    html, body {
      padding 0; margin: 0;
      height: 100%;
      
      color: white;
      font: 75% "Helvetica", "Lucida Grande", sans-serif;
    }

    #wall {
      height: 100%;
      width: 100%;
    }

    #logo {
      padding: 20px;
    }

    #info_button {
      position: absolute;
      bottom: 10px;
      right: 10px;
    }

    .image {
      position: absolute;
      margin: auto;
      background-color: white;

      padding: 10px;
    }
    
    #manual {
      float: right;
      padding: 30px 50px;
      width: 350px;
      font-size: 2.3em;
      
      text-shadow: #000 2px 2px 2px;
      color: #ececec;
    }
    
    #settings {
      position: absolute;
      top: 0; right: 0;
      
      width: 496px;
      height: 100%;
      z-index : 1;
      
      padding: 0 25px;
      
      display: none;
    }

    #done {
      bottom: 20px;
      right: 20px;
      position: absolute;
    }

    #map_canvas {
      margin: 10px auto;
      width : 488px;
      height: 350px;
    }

    a img, a:active img {
      border: 0;
    }

    img#scalable_image, img#select_bg_image {
      position: absolute;
      top:0;
      left:0;
      width: 100%;
      height: 100%;

      z-index: -1;
    }
    
    input#address_field {
      font-size: 15pt;
    }
  </style>
  <body>
    <div id="wall">
      <img src="http://hoccer.com/webapp/images/logo.png" id="logo" width="256" height="64" alt="Logo">
      <div id="manual">Throw images on this wall by using Hoccer for iPhone or Android</div>
      <a id="info_button" href="#"><img src="http://hoccer.com/webapp/images/i.png" width="46" height="46" alt="info"></a>
      <img src="http://hoccer.com/webapp/images/bg_main.jpg" id="scalable_image">
    </div>

    <div id="settings">
      <h1>Settings</h1>
      <div id="map_canvas"></div>
      <input id="address_field" type="text" value="" />

      <a id="done" href="#"><img src="http://hoccer.com/webapp/images/done.png" width="130" height="52" alt="Done"></a>
      <img src="http://hoccer.com/webapp/images/bg_settings.jpg" id="select_bg_image">
    </div>
    
    <!-- Piwik --> 
    <script type="text/javascript">
    	var pkBaseURL = (("https:" == document.location.protocol) ? "https://stats.hoccer.com/" : "http://stats.hoccer.com/");
    	document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    	</script><script type="text/javascript">
    	try {
    	var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 2);
    	piwikTracker.trackPageView();
    	piwikTracker.enableLinkTracking();
    	} catch( err ) {}
    </script><noscript><p><img src="http://stats.hoccer.com/piwik.php?idsite=2" style="border:0" alt="" /></p></noscript>
    <!-- End Piwik Tracking Tag -->

  </body>

</html>
